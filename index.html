<script>
    const spinBtn = document.getElementById('spin-btn');
    const buyChipsBtn = document.getElementById('buy-chips-btn');
    const chipBalanceSpan = document.getElementById('chip-balance');
    const resultText = document.getElementById('result-text');
    const reels = [document.getElementById('reel1'), document.getElementById('reel2'), document.getElementById('reel3')];
    const symbols = ['üçí', 'üçã', 'üîî', 'üíé', '7Ô∏è‚É£'];
    const spinSound = document.getElementById('spin-sound');
    const winSound = document.getElementById('win-sound');
    const buyChipsSound = document.getElementById('buy-chips-sound');
    const backgroundMusic = document.getElementById('background-music');
    let currentPaymentId, paymentCheckInterval, selectedPackageId, selectedAmount;
    let isMusicPlaying = false;

    // --- NENHUMA MUDAN√áA NAS FUN√á√ïES ABAIXO ---

    const startOverlay = document.getElementById('start-overlay');
    startOverlay.addEventListener('click', () => {
        startOverlay.style.display = 'none';
        if (!isMusicPlaying) {
            backgroundMusic.volume = 0.3;
            backgroundMusic.play().catch(e => console.error("M√∫sica de fundo bloqueada pelo navegador."));
            isMusicPlaying = true;
        }
    });

    document.addEventListener('visibilitychange', () => {
        if (!isMusicPlaying) return;
        if (document.visibilityState === 'hidden') {
            backgroundMusic.pause();
        } else {
            backgroundMusic.play();
        }
    });

    function triggerPulseAnimation() {
        buyChipsBtn.classList.remove('pulsating-button');
        void buyChipsBtn.offsetWidth;
        buyChipsBtn.classList.add('pulsating-button');
        setTimeout(() => {
            buyChipsBtn.classList.remove('pulsating-button');
        }, 10000);
    }

    window.onload = async () => {
        triggerPulseAnimation();
        try {
            const response = await fetch('/api/session');
            const data = await response.json();
            if (!response.ok) throw new Error("Falha na rede");
            updateBalance(data.chipBalance);
        } catch (error) {
            console.error("Erro ao carregar saldo:", error);
            chipBalanceSpan.innerHTML = `Erro. <button onclick="window.location.reload()" style="font-size: 0.7em; margin-left: 5px;">Recarregar</button>`;
        }
    };

    function updateBalance(newBalance) {
        chipBalanceSpan.textContent = newBalance;
        if (parseInt(newBalance, 10) === 0) {
            triggerPulseAnimation();
        }
    }
    
    // --- MUDAN√áAS PRINCIPAIS COME√áAM AQUI ---

    /**
     * NOVA L√ìGICA DE GIRO
     * Esta fun√ß√£o agora controla todo o processo:
     * 1. Pede o resultado ao servidor PRIMEIRO.
     * 2. Inicia as anima√ß√µes com o resultado final j√° conhecido.
     * 3. Espera as anima√ß√µes terminarem para mostrar o resultado.
     */
    spinBtn.addEventListener('click', async () => {
        const betAmount = 1;
        const currentBalance = parseInt(chipBalanceSpan.textContent, 10);
        if (isNaN(currentBalance) || currentBalance < betAmount) {
            resultText.textContent = "Fichas insuficientes!";
            resultText.style.color = 'red';
            triggerPulseAnimation();
            setTimeout(() => {
                resultText.textContent = "Boa Sorte!";
                resultText.style.color = 'var(--light-text)';
            }, 3000);
            return;
        }

        spinBtn.disabled = true;
        resultText.textContent = "Girando...";
        resultText.style.color = 'var(--light-text)';
        spinSound.play();

        try {
            // 1. PRIMEIRO, PEGA O RESULTADO DO SERVIDOR
            const response = await fetch('/api/spin', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ betAmount }),
            });

            const data = await response.json();
            if (!response.ok) throw new Error(data.error || "Erro desconhecido");

            // 2. AGORA, CRIA AS ANIMA√á√ïES QUE V√ÉO PARAR NOS S√çMBOLOS CORRETOS
            const animationPromises = reels.map((reel, index) => {
                // A dura√ß√£o do giro de cada rolo √© ligeiramente diferente para um efeito mais natural
                const duration = 4000 + (index * 500); 
                return animateReel(reel, data.symbols[index], duration);
            });
            
            // 3. ESPERA TODAS AS ANIMA√á√ïES TERMINAREM
            await Promise.all(animationPromises);

            // 4. AP√ìS A ANIMA√á√ÉO, ATUALIZA O TEXTO E O SALDO
            if (data.winnings > 0) {
                resultText.textContent = `Voc√™ ganhou ${data.winnings} fichas!`;
                resultText.style.color = 'var(--secondary-color)';
                winSound.play();
            } else {
                resultText.textContent = "Tente Novamente!";
                resultText.style.color = 'var(--light-text)';
            }
            updateBalance(data.newBalance);

        } catch (error) {
            resultText.textContent = error.message;
            resultText.style.color = 'red';
        } finally {
            // Garante que o bot√£o seja reativado no final, mesmo se der erro
            spinBtn.disabled = false;
        }
    });

    /**
     * NOVA FUN√á√ÉO DE ANIMA√á√ÉO
     * Esta fun√ß√£o agora √© programada para parar em um s√≠mbolo espec√≠fico.
     * @param {HTMLElement} reel - O elemento do rolo para animar.
     * @param {string} finalSymbol - O s√≠mbolo em que o rolo deve parar.
     * @param {number} duration - Dura√ß√£o da anima√ß√£o em milissegundos.
     * @returns {Promise<void>} - Uma promessa que √© resolvida quando a anima√ß√£o termina.
     */
    function animateReel(reel, finalSymbol, duration) {
        return new Promise(resolve => {
            const reelSymbols = reel.querySelector('.reel-symbols');
            const spinCount = 50; // Aumenta o n√∫mero de s√≠mbolos para um "blur" mais longo
            
            // Reseta a posi√ß√£o e transi√ß√£o para um novo giro
            reelSymbols.style.transition = 'none';
            reelSymbols.style.top = '0';
            
            // For√ßa o navegador a aplicar o reset antes de adicionar a nova anima√ß√£o
            void reelSymbols.offsetHeight; 

            // Cria a lista de s√≠mbolos aleat√≥rios, com o s√≠mbolo final na √∫ltima posi√ß√£o
            let symbolHtml = '';
            for (let i = 0; i < spinCount - 1; i++) {
                symbolHtml += `<span>${symbols[Math.floor(Math.random() * symbols.length)]}</span>`;
            }
            symbolHtml += `<span>${finalSymbol}</span>`; // O √∫ltimo s√≠mbolo √© o correto!
            reelSymbols.innerHTML = symbolHtml;
            
            // Calcula a posi√ß√£o final
            const finalPosition = (spinCount - 1) * 100;

            // Define a transi√ß√£o e a posi√ß√£o final para iniciar a anima√ß√£o
            const durationInSeconds = duration / 1000;
            reelSymbols.style.transition = `top ${durationInSeconds}s cubic-bezier(0.25, 1, 0.5, 1)`;
            reelSymbols.style.top = `-${finalPosition}px`;
            
            // Resolve a promessa quando a anima√ß√£o CSS terminar
            reelSymbols.addEventListener('transitionend', resolve, { once: true });
        });
    }

    // --- NENHUMA MUDAN√áA NAS FUN√á√ïES DE COMPRA DE FICHAS ABAIXO ---

    function openBuyChipsModal() {
        buyChipsSound.play();
        const modal = document.getElementById('buy-chips-modal');
        modal.style.display = 'flex';
        if(!modal.innerHTML.trim()){
            modal.innerHTML = `<div class="modal-content"><span class="close-button" onclick="closeBuyChipsModal()">&times;</span><div id="chip-options-view"><h2>Comprar Fichas</h2><div class="chip-options"><div class="chip-option" onclick="selectChipPackage('pack_10', 5.00)"><strong>10 Fichas - R$ 5,00</strong></div><div class="chip-option" onclick="selectChipPackage('pack_25', 10.00)"><strong>25 Fichas - R$ 10,00</strong></div><div class="chip-option" onclick="selectChipPackage('pack_250', 50.00)"><strong>250 Fichas - R$ 50,00</strong></div></div></div><div id="email-prompt-view" style="display: none;"><h2>Quase l√°!</h2><p>Em caso de vit√≥ria, entraremos em contato atrav√©s desse e-mail.</p><input type="email" id="email-input" placeholder="seuemail@exemplo.com"><button id="generate-pix-btn" onclick="generatePix()"><strong>Comprar Fichas</strong></button></div><div id="pix-payment-view" style="display: none;"><h2>Pague com PIX</h2><p>Escaneie o QR Code abaixo:</p><img id="qr-code-image" src=""><p>Ou use o PIX Copia e Cola:</p><div id="pix-code-group" style="display:flex;margin:10px 0;"><input type="text" id="pix-code-input" readonly style="flex-grow:1;padding:10px;border:1px solid #777;background-color:#444;color:white;border-radius:5px 0 0 5px;"><button id="copy-pix-btn" onclick="copyPixCode()" style="padding:10px 15px;background-color:var(--primary-color);color:white;border:none;border-radius:0 5px 5px 0;cursor:pointer;font-weight:bold;">Copiar</button></div><p id="payment-status">Aguardando pagamento...</p></div></div>`;
        }
        document.getElementById('chip-options-view').style.display = 'block';
        document.getElementById('email-prompt-view').style.display = 'none';
        document.getElementById('pix-payment-view').style.display = 'none';
    }

    function closeBuyChipsModal() {
        document.getElementById('buy-chips-modal').style.display = 'none';
        if(paymentCheckInterval) clearInterval(paymentCheckInterval);
        if(isMusicPlaying && backgroundMusic.paused) {
            backgroundMusic.play();
        }
    }
    
    function selectChipPackage(packageId, amount) {
        selectedPackageId = packageId;
        selectedAmount = amount;
        document.getElementById('chip-options-view').style.display = 'none';
        document.getElementById('email-prompt-view').style.display = 'block';
    }

    async function generatePix() {
        const emailInput = document.getElementById('email-input');
        const email = emailInput.value;
        if (!email || !/^\S+@\S+\.\S+$/.test(email)) {
            alert("Por favor, insira um e-mail v√°lido.");
            return;
        }
        document.getElementById('email-prompt-view').style.display = 'none';
        document.getElementById('pix-payment-view').style.display = 'block';
        document.getElementById('payment-status').textContent = "Gerando PIX...";
        try {
            const response = await fetch('/api/create-payment', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ packageId: selectedPackageId, amount: selectedAmount, email: email }), });
            const data = await response.json();
            if (!response.ok) throw new Error(data.error);
            document.getElementById('qr-code-image').src = `data:image/png;base64,${data.qrCodeBase64}`;
            document.getElementById('pix-code-input').value = data.qrCode;
            currentPaymentId = data.paymentId;
            startPaymentCheck(currentPaymentId);
        } catch(error) {
            document.getElementById('payment-status').textContent = error.message;
        }
    }
    
    function copyPixCode() {
        const input = document.getElementById('pix-code-input');
        const button = document.getElementById('copy-pix-btn');
        input.select();
        navigator.clipboard.writeText(input.value);
        button.textContent = 'Copiado!';
        setTimeout(() => { button.textContent = 'Copiar'; }, 2000);
    }

    function startPaymentCheck(paymentId) {
        document.getElementById('payment-status').textContent = 'Aguardando pagamento...';
        if (paymentCheckInterval) clearInterval(paymentCheckInterval);
        paymentCheckInterval = setInterval(async () => {
            try {
                const response = await fetch(`/api/check-payment?paymentId=${paymentId}`);
                const data = await response.json();
                if (data.status === 'approved') {
                    clearInterval(paymentCheckInterval);
                    document.getElementById('payment-status').textContent = 'Pagamento aprovado! Fichas creditadas.';
                    updateBalance(data.newBalance);
                    setTimeout(closeBuyChipsModal, 2000);
                }
            } catch(error) {
                console.error("Erro ao verificar pagamento");
            }
        }, 5000);
    }
</script>
